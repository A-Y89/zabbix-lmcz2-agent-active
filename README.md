# Шаблон мониторинга СПО «Локальный модуль «Честный ЗНАК» v2 через Zabbix Agent активный.

## Обзор

Шаблон для мониторинга основных параметров ЛМЧЗ v2 без внешних скриптов.
Данные собираются из API /api/v2/status 

## Требования

Версия Zabbix: 7.0 и выше.

## Протестированные версии

Шаблон протестирован на следующих версиях:

ЛМЧЗ: 
- [x] 2.1.0-627

## Конфигурация
### Для linux серверов:
Внести в zabbix_agentd.conf или в ваш файл с UserParameter строку:

```
UserParameter=lmcz-v2.getStatus, curl -s http://localhost:5995/api/v2/status
```

### Для windows серверов:
Внести в zabbix_agentd.conf или в ваш файл с UserParameter строку:

```
UserParameter=lmcz-v2.getStatus, powershell -c "(Invoke-WebRequest -Uri \"http://localhost:5995/api/v2/status\" -UseBasicParsing -Method 'GET' -DisableKeepAlive).Content"
```


## Установка

1\. Создать хост для каждого ЛМЧЗ

2\. Присоединить шаблон к хосту

### Макросы

Отсутствуют.

### Элементы данных

|Имя|Описание|Тип|Ключ и дополнительная информация| Комментарий |
|----|-----------------------|-------|----------------|----------------|
|Данные /api/v2/status|<p>Возвращает JSON массив с исходными данными.</p>|Zabbix агент (активный)|lmcz-v2.getStatus<br>| |
|Версия СПО «Локальный модуль «Честный ЗНАК»||Зависимый элемент данных|lmcz-v2.version<p>**Предобработка**</p><ul><li><p>JSON: `$.version`</p></li></ul>| |
|Версия базы данных «чёрного списка»||Зависимый элемент данных|lmcz-v2.dbVersion<p>**Предобработка**</p><ul><li><p>JSON: `$.dbVersion`</p></li></ul>|Выключен по-умолчанию|
|Дата и время последней синхронизации||Зависимый элемент данных|lmcz-v2.lastSync<p>**Предобработка**</p><ul><li><p>JSON: `$.lastSync`</p></li></ul>||
|ИНН участника оборота||Зависимый элемент данных|lmcz-v2.inn<p>**Предобработка**</p><ul><li><p>JSON: `$.inn`</p></li></ul>|Выключен по-умолчанию|
|Идентификатор экземпляра СПО «Локальный модуль «Честный ЗНАК»||Зависимый элемент данных|lmcz-v2.inst<p>**Предобработка**</p><ul><li><p>JSON: `$.inst`</p></li></ul>|Выключен по-умолчанию|
|Наименование программного обеспечения||Зависимый элемент данных|lmcz-v2.name<p>**Предобработка**</p><ul><li><p>JSON: `$.name`</p></li></ul>|Выключен по-умолчанию|
|Последнее известное время запуска одной из действующих репликаций||Зависимый элемент данных|lmcz-v2.lastUpdate<p>**Предобработка**</p><ul><li><p>JSON: `$.lastUpdate`</p></li></ul>|Выключен по-умолчанию|
|Состояние репликации blocked_cis||Зависимый элемент данных|lmcz-v2.dbState.blocked_cis.docCount<p>**Предобработка**</p><ul><li><p>JSON: `$.dbState.blocked_cis.docCount`</p></li></ul>|Выключен по-умолчанию|
|Состояние репликации blocked_gtin||Зависимый элемент данных|lmcz-v2.dbState.blocked_gtin.docCount<p>**Предобработка**</p><ul><li><p>JSON: `$.dbState.blocked_gtin.docCount`</p></li></ul>|Выключен по-умолчанию|
|Состояние репликации min_price||Зависимый элемент данных|lmcz-v2.dbState.min_price.docCount<p>**Предобработка**</p><ul><li><p>JSON: `$.dbState.min_price.docCount`</p></li></ul>|Выключен по-умолчанию|
|Статус СПО «Локальный модуль «Честный ЗНАК»||Зависимый элемент данных|lmcz-v2.status<p>**Предобработка**</p><ul><li><p>JSON: `$.status`</p></li></ul>|
|Тип режима обслуживания||Зависимый элемент данных|lmcz-v2.operationMode<p>**Предобработка**</p><ul><li><p>JSON: `$.operationMode`</p></li></ul>||


### Триггеры

|Имя|Условия|Важность|Зависимости и дополнительная информация|
|--------------|---------------------------|--------|----------------|
|[ЛМЧЗ] Данные не синхронизировались более 1 суток|`last(/LMCZv2 by zabbix agent active/lmcz-v2.lastSync)<(now()-86400)`|Предупреждение||
|[ЛМЧЗ] Некорректный статус ({ITEM.LASTVALUE})|`last(/LMCZv2 by zabbix agent active/lmcz-v2.status)<>"ready"`|Высокая||
|[ЛМЧЗ] Некорректный тип режима обслуживания ({ITEM.LASTVALUE})|`last(/LMCZv2 by zabbix agent active/lmcz-v2.operationMode)="service"`|Средняя||
